# SQL-—Å–∫—Ä–∏–ø—Ç —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìå –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞

### 1. –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π log_user_changes()
### 2. –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã users users_update_trigger
### 3. –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö export_daily_user_changes()
### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ cron.schedule

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|------------------|--------------------------------------------------------------------------|
| **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –ø–æ–ª—è** | `name`, `email`, `role`                                                  |
| **–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞**    | CSV —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏                                                       |
| **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**      | –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ `3:00 UTC`                                                  |
| **–õ–æ–∫–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤**     | `/tmp/users_audit_export_YYYY_MM_DD.csv`                              |
| **–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**    | –§–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è |

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å—å —Å–∫—Ä–∏–ø—Ç –≤ –≤–∞—à–µ–π PostgreSQL –ë–î.
2. –ü—Ä–æ–∏–∑–≤–µ–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`.
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `users_audit` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–µ–π.
4. –î–æ–∂–¥–∏—Ç–µ—Å—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è cron –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:

   ```sql
   SELECT export_daily_user_changes();
   ```

##  –°—Ö–µ–º—ã —Ç–∞–±–ª–∏—Ü: 

 ```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    role TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE users_audit (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    changed_by TEXT,
    field_changed TEXT,
    old_value TEXT,
    new_value TEXT
);
  ```